#include <stdint.h>
#include "common.h"
#include "common_math.h"

#ifndef LOOPS
#define LOOPS 1
#endif

#ifdef ALIGNED
#define ALIGN __attribute__((aligned(64)))
#else
#define ALIGN
#endif

#if defined(LEN_SMALL)
#define IN_LEN 16
#define F_LEN 5
#elif defined(LEN_LARGE)
#define IN_LEN 1024
#define F_LEN 31
#else
_Static_assert(0, "Unsupported array length");
#endif

#define OUT_LEN IN_LEN - F_LEN + 1

#if defined(NF_INT16)
int32_t out[OUT_LEN];

#if defined(LEN_SMALL)
int16_t ALIGN in[IN_LEN] = {
    -30036, 10799, 9845, 19648, 1, -11525, -2365, 1,
    9225, 24275, 1, 1, 14116, -17833, -17338, 15832 };
int16_t ALIGN filter[F_LEN] = { 6744, 19852, -18118, -15679, -538 };
int32_t ALIGN ref[OUT_LEN] = {
    -474614276, -81526297, 638401503, 378416211, -190917215, -282391423,
    -563676521, -256689223, 536492495, -48018276, 33204359, 866660756 };

#elif defined(LEN_LARGE)
int16_t ALIGN in[IN_LEN] = {-15018, 5399, 4922, 9824, 6561, -5763, -1183, -333, 4612, 12137, -6006, 11129, 7058, -8917, -8669, 7916, 3372, 9926, -9059, -7840, -269, -6893, 5163, 9303, -4308, 1448, 13138, -7924, -2650, 3108, -12924, 3018, -15303, -13848, 2425, -12446, -7169, -15449, -12585, -15136, 7593, -4047, 5100, -424, 377, -15986, 8521, -14775, -8761, -3885, 11920, -8224, 9860, -6820, 10559, 4368, 11535, 8549, -7046, 12363, 13649, -769, -10523, 5561, -7589, 11278, 12689, 5184, -3008, 13266, -4582, -13374, -6381, -14604, -3718, 14472, -857, 6338, 9012, 13845, 6877, 7439, -5700, -6016, 15008, -2061, 0, -3044, -9071, -10317, 13883, 7557, 4311, 11817, -6099, 15296, 13511, 9521, -11494, -6714, -2756, -8235, -10198, 9317, -14174, 6531, 3554, -7657, 14655, -9222, 2625, 14822, -12878, -11686, 7156, -14425, -11705, 9034, 5745, -4643, -8821, 5479, 1478, 2234, -9302, -12008, 15000, 4898, -9132, -13487, 8928, -4561, 3682, -2257, 4224, 11192, 1881, 14994, 13265, -3688, -8274, -6975, 817, 7957, -15898, -5960, -11277, -10806, -3996, 13503, -9472, 15301, -15175, -9963, -9763, 1727, 11275, 11101, 14401, -13124, -5071, 12063, -11823, -657, 15421, 5089, 11561, -9257, 9585, -4534, 2152, 9497, 2765, -4729, -492, 15901, -8864, 11794, -4731, 2091, 0, -9804, -3067, 7553, 153, -9688, -9200, -13733, 576, -4717, 4233, 2647, 6933, 6841, 8796, 1246, -2828, 7974, 7311, -9588, -3778, 385, -8447, -12241, 5745, 2997, 16006, 15288, -7020, -9564, -14839, 6447, -14428, 8909, -13087, -5508, 12378, 13473, -4618, -12386, 10119, 4016, -8574, 4065, -13962, -3003, 10750, 5419, -14618, -14916, -3274, 2469, 15708, 4872, -6580, -13874, -2998, 567, 8204, 4840, -7714, -15428, 9659, -9670, 13022, -9431, 1360, -11340, 8656, -8590, 2813, 13693, 11324, 2723, -16150, 5263, -12026, 9123, 860, 2636, -7897, 3092, 9353, -8428, -2341, -8089, 0, 10323, -9161, 9902, -2052, 10816, 15727, 5051, -10858, 12396, -8514, 12300, -2015, 5609, -13833, 12161, 1141, -15514, 11251, -10095, -13461, 6655, 7518, -6302, -14997, -6891, -1008, -4603, -9420, -13206, 581, 7003, -2059, 15058, -8386, 16206, 311, -268, -11903, 15117, -6167, 620, 5451, 12698, -14183, -7593, -1462, -6694, 2830, -8415, -10991, -7789, 14020, -15324, 6292, 15819, -4159, -14441, 4461, -5159, -8778, -11391, 9103, 7556, 14021, 14093, 6358, -8093, 723, -13794, 5290, 14768, 13846, -10863, 5073, -13780, -13296, 7490, 15476, -13953, 11282, 9088, 8933, 7313, -12190, -15937, 15322, 10879, 7720, -1313, 68, -2978, 3136, 13416, -3400, 7313, -9540, -14675, -8108, -13382, 1426, 6232, 4876, -5983, 12211, 12542, -8815, 1593, -5233, -5618, -7304, 9872, 4169, 10888, 10350, -9046, -5890, -15103, -5086, 15026, -3642, 2326, -9798, -2690, 6817, -2249, 11309, -10582, 211, 14099, 16357, -2229, 14031, 14152, 11619, 483, 2185, 4526, -5099, 10793, 216, -9836, -5074, 14935, -7478, 14436, 6060, -6919, -784, -9235, -8028, -6386, -8203, -3992, 11572, 15325, 1984, -4117, -225, -15864, -13259, 12370, -3793, -12532, -12998, 2655, 4705, -3431, 6212, -11812, 14765, -2514, 3005, 9591, 14891, 4176, -15287, -14044, 11491, -3541, 9734, -355, 11048, 2620, -11334, 13787, -8800, 5477, 366, 10706, 12428, 6544, -4395, -10361, -5909, -11634, 3722, -23, 9890, 6923, 10865, -4675, 8489, 323, -10268, -7906, 3398, 2818, 12416, -2492, 5735, 7399, -38, 2629, 4610, 3283, 2222, 9686, 14989, 293, -9318, 10743, -12584, -2451, -10855, -16015, -1612, -5751, -2374, -13679, 7961, 8015, -7974, -14435, -2091, 0, -11522, 8702, -4727, -15914, -2645, -3872, -10589, 10997, -10726, -11880, -465, -7139, -9048, -3251, -1218, -6063, -10467, -7720, 14901, -12188, 11926, -7290, 7612, -15453, 4371, 1875, 4932, 15878, 9212, -15933, -1176, -8708, 15627, -3844, -4185, -9236, -13436, -10383, -12413, -4504, 4835, 15594, 2796, -8223, -1250, 14536, 9756, 3513, 1910, -6837, -12148, -15870, 1330, 14838, -15208, -2901, -5361, -12517, -4020, -2166, -4432, -2894, -10916, 6347, -307, -15858, -6704, -5447, 1946, -15045, -10791, -13909, -773, 14339, -15052, -6664, -956, 3419, 1984, -15959, 12988, -13870, -6296, -4534, 12218, 3576, 9857, -4033, 11157, -12000, -5366, 402, 2722, 9704, -8136, 983, -7867, 2166, -15692, 6639, 15277, -9451, -16353, 1999, -14390, 9443, 14980, 9950, 6445, -6857, 6865, 1193, -3162, -5495, 1720, -12379, 13425, -9616, 9173, -13503, -6714, -12686, 1949, 10176, -9032, 11840, -5741, 14860, -3747, -8046, -847, 12706, 7235, 10241, -13711, -4676, 2388, -802, -9520, -4466, 11682, -14323, -16016, -2948, 2230, -7207, -10652, -9510, 4194, 6608, 835, 13630, 303, -7132, 6267, 11690, 12867, 9057, 13418, -8467, -12490, 9889, 3123, -4182, -2909, -3799, 2671, -15232, -10430, 1709, 565, -561, -9244, -7191, 14083, 13898, 5106, -4370, -9532, 9045, -11497, -12288, -12620, 345, 6931, 14892, -2523, -6919, -2703, -15043, -3925, -8656, -12887, -1907, 11623, -13296, -2503, 3299, -13392, 2262, 413, -11364, 11609, -11178, -1164, -14782, 14044, -16338, 7853, -9528, 1233, 1889, -16182, -13866, -3492, 6631, -16197, -8366, 10164, -10913, -254, -7944, 12025, -4506, -11569, -1354, -1109, 4465, -14127, 3364, -14739, 5083, 781, 15035, -1525, -3866, -665, 16049, -2259, 9753, -525, 9111, -8344, 16158, 13022, 11671, 15357, 7220, -14016, -14651, -6171, 11206, 14499, -14033, 2819, 3926, 7802, -13617, 6919, 7252, 3155, 6810, -14891, -5847, -2365, -14738, 9632, 2900, 15777, 11833, -10834, 4263, -3726, -3475, -389, -12238, 9423, -11154, 14937, 3838, -4009, -3794, -12487, -6320, 2438, -6288, 4980, 4520, 12833, -5404, -1543, -15298, -11707, -5832, -12947, -7603, -3748, -4548, 14496, -6944, -15006, -10324, -4463, -14361, -7167, 11614, 9847, -12462, 15957, 9065, 5548, 16163, -12470, -3645, 1934, -5831, 2499, -13919, 8494, 12270, 1843, -3662, -6467, -6302, -9674, 4772, -16334, 10587, -11866, -13366, 11005, -3761, 10024, 9745, -3978, 7801, 7293, -828, 11647, 4748, -8182, -4906, 8818, 3051, -3896, -1460, 12791, -14789, 4946, 4031, 15040, 15042, 9059, 3270, -14675, -11995, -515, 10715, 3623, 4511, 13092, -925, 16278, -6590, 7959, 14685, -5547, 10465, -13243, 10617, -15716, 1773, -9556, -7999, -13762, -2713, -14423, -15774, 7005, -15422, 11784, -11934, 4319, 8367, -11956, -6335, -1886, -12076, 2130, 12061, 4696, -14629, -10932, -16048, 969, 12208, 6375, -3720, -12733, 9178, -1675, 14359, 16120, -518, 5439, -560, 4264, 10830, -2298, 14139, 5015, 13755, -1904, 3985, 8249, -13525, -2754, -1844, -2473, -11015, 12213, -230, 12276, -9929, 2848, -14682, 14267, -10972, 2121, 9602, 9091, 1345, 4632, -2522, -13166, -10182, 4854, -11496, 3126, -11287, -11175, 5400, 5667, 8109, 5848, -6153, 2702, 10497, -12251, -214, -4875, 5792, 3003, -14582, -14744, -13803, 2809, 8206, 717, 1451, 1626, -13160, 7137, -3277, -3708, -12671, -10566, 15798, -1164, 6572, 6846, -3654, -16078, -14291, -3550, 12596, 4869, -6138, 11060, 5232, -2862, -6061, -11824, 12989, 5776, -11827, -16335, 11884, -15207, 13484, 15977, 11146, 6511, 16206, -15580, 10889, -1332, -3636, -12525, -10635, -9411, 8334, -1204, -10423, 16225, 7254, 8041, 13462, 5531, -8192, 13381, 10593, 15299, 2925, 7089, 5340, 14307, 9673, 12881, -15335, 7289, 2483};
int16_t ALIGN filter[F_LEN] = {-6140, -5189, -3970, 5350, 1120, -1975, -4075, 1574, 4960, -1713, 361, -2639, -3578, -1199, 386, 794, -198, 5683, -6501, 2254, -27, -5478, 1761, -838, 2523, 6013, 5188, -948, -2794, -1910, -41};
int32_t ALIGN ref[OUT_LEN] = {290697855, 94561175, -247171046, -33993179, -10260709, -132940612, -5722892, -74731585, -82737789, 210141547, -246042051, -360376191, 113056167, -263308690, 79113577, -70532315, -59632376, 99849031, 235829123, 92383731, 11385701, 23660228, -308987878, -10299533, 47084916, -77988941, 168707639, 215975493, -90020804, -11776178, 159704249, 72294302, 128129798, 306035346, 30654005, 341716029, -6718318, 199283063, -40113248, 37627954, 88990939, 56888919, 16972478, 250647780, 49808771, -181624019, -6605274, -43381726, -290834471, 70807988, 17416517, -10258366, 247207276, 223040678, -304275619, -17776077, -91374303, -215094843, 51125736, -68256955, -501979, 78548895, 201643903, -382484024, -79323606, -72718311, -145173751, 113193562, -99338383, -126407064, 218093954, 490928032, 3732502, 49536290, -157262749, -307591939, 141690073, -94737340, -176544665, -323264880, -138567, 40934743, -40252665, 123988753, -185732566, -165969007, 248410388, -34784313, 217571683, 112641310, -554422957, -71913874, 184404643, -114251355, -20722858, -110196663, -255360130, 99641173, 77083169, -233784611, 201604901, 212124850, 98413204, -19712383, 128705785, -241929235, -66882416, 126293174, -134947529, -58487880, 122483717, 198808374, 42105433, 313008052, -25291656, 77864508, -111654941, -189636783, 261701577, 94622184, -130139992, -316672396, -162618835, 289242114, 96720549, -95653621, -43384360, 19265953, -170948392, 53313927, -81021200, 85202481, 330053261, -116105008, 216227803, -8138793, -250905693, -536071894, -56576362, 277019487, 97818307, 398333579, 37620473, -196479790, 167408378, -120376991, 147600266, 65940331, 108053314, 66409582, -68035128, 17727669, 23986453, 246877021, -31839895, -92694025, -287094702, -112664512, 335551139, -286853057, 57611121, -64510515, -134113782, -79854409, -204197542, -129589013, -47299457, 261473919, 91862593, 79285464, -176175295, -32644683, 102610958, -52046254, -9328613, 45470140, 23116236, -290239811, -142679089, -95151239, 225155731, 384608044, 86508909, -170637980, -77837497, 57675415, -136537975, 189465183, -159288733, 11772996, 162074172, 227035198, -110467963, -281023735, 97687559, -313888863, 30504890, 24279991, 37771409, -22959589, 41567314, 316097051, -103081899, 157527453, -181890837, -441866282, -11488314, 72077895, 282466552, 29815977, 91238050, -330610955, 145266644, 379100732, 16522891, -235556652, -180678911, 101350648, 181346524, 73744573, -145133330, -414269950, 198777074, 176581916, 66891133, 83891231, -139700395, 149998846, 144837548, 337668471, -235989496, -63021993, -270487404, -15350234, 150166805, 276273364, 235400163, -220021778, -83387457, -203700572, 27671519, 50576056, 16596110, 56267782, -56593554, 313004010, -210016781, 336193843, -12105755, -3109335, -34173029, -348849907, 75481046, 60729286, 123921335, 69501993, 70531719, -256341101, 102767418, 19304484, -239255488, -261461669, 347939534, -50764403, 136232192, 75925795, -380321760, 24694750, 61591849, -168064662, -219190161, -132617624, -30828313, 19589314, 319493745, -107439524, 11635439, 24916785, -160562786, 78478655, 76643622, -72570947, 114031698, 117637111, 216241418, 84020311, -33662388, -428674370, 60826185, 202496463, -4100175, -122526421, 129761299, 24607811, 167640899, 228092678, -23053574, -192310510, 181976494, -90574835, -369251187, -25379314, -54054122, -205847789, 349481577, 324775570, 239057107, -91990241, -234009262, -288300868, -15637916, 197400094, 163505187, 228743186, 268819900, 67635013, -320682586, 23544037, -5327153, -294861788, -191405321, 412753990, 195551063, 226013458, 42497236, -362119494, -192653295, 294508016, -76021098, 147989081, 54785617, -371531367, -153804513, 238761096, 6749650, 157601257, -36463492, -215121487, -395240528, 73126665, -3742475, 60058047, -2127321, -269592614, 271742977, 368053231, -109554984, -320854100, -267422057, -8854628, -51833589, 277693077, -175695581, 78151521, 263664917, 3960031, -39307087, -259689057, -188169720, -276239064, 187731050, -29823790, 93517694, 433185133, -29339703, 113813996, -142491067, -192044566, -46805007, -152590925, 250850920, -36205665, 151485479, 117336254, 37044297, 162460839, 71253189, 1363064, -222883393, -45681929, -172682680, 87239457, 153008173, 78221201, -92015986, -169676506, 151798090, 83925366, 50037475, 23009354, -302575030, -242577651, 143130070, -281385714, -142968542, 246826427, 67376361, 111357038, -166094596, -410097899, -423362248, 72159318, 107103167, -126805195, -10024094, -17804665, 47709291, 112027017, 51797003, -302166466, -72395058, -140408722, 89620537, 150259205, 385574567, 89874809, -29784882, 173136877, -206331122, 73488990, -135071103, -87467451, -30955352, 95993575, 412658915, 23330805, -188367506, -191367052, -76965304, 395140578, 51862870, 343488539, 165939072, -89317146, -180814454, -459402846, -45651303, 4289937, 7327570, -162434998, 109365532, 290028420, 23768707, 139847925, -303161437, -208000268, -194104743, -29183673, 149611686, 211169755, 19758854, -110265087, 127391119, -148413581, -106983838, -165262723, -256926880, 163990985, 231757226, 236887318, 119619865, 134288216, -110067372, -199562233, -205083600, -90337013, -245002010, -31599839, -98333713, -106951904, 312105777, 8144243, -49800361, -112857339, -163662858, -95029593, -104752047, 165565679, -107559103, 25349577, -23138397, 43342897, -235400861, -201790931, 186306440, -235072388, 71125491, 49200046, -106460979, 236465211, 273776699, -231398308, 1343415, 247611047, 50769508, 45427325, 19930819, -30680269, 184725613, 6363862, 108831299, -37195036, -21427381, 215718488, 223997128, 295489183, -91328722, 66094939, -98420156, 89078802, 205464387, -116437315, 201399217, 35080161, -202983918, -111804970, -128960931, 327764434, 33698647, 196980461, -94109658, 113202697, -26703163, 12521732, 112653730, 124169349, 90674021, -103925364, -308459416, -107286109, 41044502, 185082585, -49413938, -10684712, -237204944, 147670328, -54081189, -221331383, 239089410, 258252834, 399934878, 18758975, -361468172, -153341495, 88303844, -47815967, -36885261, -165304786, -136115862, -43728290, 60752239, 146364426, 155503652, 134857652, -145637384, 115961762, 80199281, -36471304, 233196451, -172684230, 169871860, 38092952, 350298503, 213419200, -160787206, 106411270, -41107854, 189464124, -73639842, 4215280, 93515876, 456130653, 180988440, -70390148, -257599264, 4251326, 161625638, 60616620, -21873162, 16745777, -90293777, -280678352, 237530833, 304023325, -45166026, 251120098, -29918921, -49603947, -31521947, -269636552, -88013019, 97375566, 93340829, 99470226, 207184786, -74226046, -195588565, -340013690, 40996456, 208230313, -63249374, 41546705, -49901217, 236449176, 105088713, 229319622, -250050199, -210096169, 45330987, -43330765, 306339139, -145277896, -10753324, -23533373, -195691342, 62182364, 98769892, 118264684, -191439143, -38969681, -1147454, 88420022, 72104603, -209549895, -196293304, 163404970, 239026359, -7659413, -71960593, -166502020, 46568290, 203115070, -2372886, -106630282, 324112231, 10958407, -57236010, -24373328, 127441090, 57289778, -140270940, -20459515, 10304520, 331763742, -25282353, -254257004, 45214278, -17128941, -7673104, 42859849, 30534352, 122554072, 7625122, -48274439, -17174837, 55115981, 27498279, -193871168, -525341682, -224474318, 88470285, 310103794, 203748290, -24604178, 101675654, -108686775, -282819816, -207129554, 114572812, 113572501, 272088159, 1678485, -79332412, 358474262, 14813375, -338238272, -220810124, -91018280, 63600913, 350847818, -66369344, -251867948, 436346180, -22387526, 136818527, -16577727, -144452433, -1516397, 111791638, 22718515, -283268300, 379059098, -163834305, 245198329, 82624706, -40928975, 34715517, 34977189, 163125454, -178578407, 256489138, -44331330, -55540077, 230753172, -157615231, 340228035, -304705549, 79661189, -97080884, 411068763, 41357447, -171759270, 83622876, 70647154, 340776842, -75702935, 191354170, 103251266, -96962534, 74000037, 85243426, 343161641, 146285673, 97531532, -34331299, -206196864, 49059356, -220577313, 118942810, -49323705, 77115262, 224011699, 270936961, -310728083, -209456021, -163797925, 3233455, 128338521, 128074755, -94510544, -165204437, -157433411, -371113513, -34304645, 194947981, 36816190, 261424139, -442396849, -285593739, 79088196, 47103194, 97281387, -310018811, 33245690, 281039229, 155282692, 27699571, -204590831, -33305862, -151928544, -283315788, 25771647, -169734215, 280261026, 195677903, 204255582, 257816870, -4119377, -256563326, -429342842, -162324735, -155214507, 9732664, 258466445, 22794891, 298775376, -85401030, -85277827, -53724105, -343396159, -243606425, 111817675, 191271211, 215006225, 148721656, 204846526, 70835904, 212031357, -28828998, -317461148, -118679810, 275065218, -56910491, 209350899, 67289576, -16856737, 496944875, 145146373, -110377672, -129195132, -197983743, 33925149, -61555100, 263759942, 183386242, 131686680, -290935553, 26426866, 34334743, -85456195, 184563530, -519009440, 130274439, 203985928, 12686359, 221203595, -206820392, 10408138, 207859369, 82628551, -208724498, -577817, 6196004, -200445165, 108704945, -7976212, 148474226, 79086565, 292359331, 172355909, -4647327, 34192678, -385338142, -69001665, -146652688, -28762212, 156928505, 168840625, 27296988, -233894270, -72191087, -118840516, 85528384, -48772440, 72246432, 339851005, -316742853, 175657503, -314724717, 5586679, -78430143, -139129795, -131174709, -602286345, 42621337, -105891648, 248990332, -17157233, 81667051, -25319310, 79172529, -90092569, -411598997, 129038341, -320635734, 282034895, 153182227, -112049521, 81771387, -322690033, -100830253, -42713868, 317967086, -17596452, 180759880, 92372571, -51178358, 399719249, 117488832, 158077255, -94264482, 196301414, 136305523, -52033124, 164569506, -214359384, -22118225, 306482625, 191583961, 338354688, -135652463, -264776272, -243288584, 85077896, 287097603, -157056177, 93667370, -181700262, 64090435, 130537541, 40836012, -165342190, -208884812, -213582226, -258471792, 128488711, 116153751, 51942583, 147836150, 103974888, -392497452, -203083581, -159722232, -175585889, -37151545, 55459850, -32600798, -117217664, 131193234, 77096222, 48848854, 228899985, -373273005, 163729950, 33540900, 6782844, -69151395, 155880427, 16994894, 190057319, -136159738, -338641444, -137315687, -241935213, 82310115, 227447953, 211631705, 121540393, -80436467, 85974862, -17805009, 7600604, -34533495, -157993574, 15535415, 314388930, 166350786, 62573701, -367117475, -239093671, 56592758, -31200208, 100278974, -102965846, 201578077, 417483336, 315500741, -52958876, -195684820, -252144224, -103170435, 322111444, -51249436, 89441285, -186993846, -88311756, 240326345, 134278315, 65341583, 297650274, 62799954, -430792888, 201189930, 104478806, -4928642, 45968238, -223937168, -50282799, 322274172, -326769246, -331119927, 69690245, 229708802, 94782330, 200523319, -331968036, 844349, 257163996, 77715032, 180043098, 218043334, -252647752, -80159467, -49806502};

#else
_Static_assert(0, "Unsupported array length");
#endif

#else
_Static_assert(0, "Unsupported number format");
#endif

void conv1d_int16(
    const int16_t *in, size_t in_size,
    const int16_t *filter, size_t filter_size,
    int32_t *out)
{
    size_t out_size = in_size - filter_size + 1;

    // aligned copy for SIMD even iterations
    int16_t filter2[filter_size];
    for (size_t i = 0; i < filter_size-1; i++) filter2[i] = filter[i+1];
    filter2[filter_size] = 0;

    const int16_t *filter_ptr = filter;
    const int16_t *filter2_ptr = filter2;
    int32_t sum = 0;
    for (size_t i = 0; i < out_size; i+=2) {
        const int16_t *in_ptr = in + i;
        sum = _simd_dot_product_int16(in_ptr, filter_ptr, filter_size);
        *(out + i) = sum;

        const int16_t *in_ptr2 = in + i + 1;
        sum = *(in_ptr2) * *(filter_ptr); // handle unaligned input element

        sum += _simd_dot_product_int16(in_ptr2+1, filter2_ptr, filter_size-1);
        *(out + i + 1) = sum;
    }
}

void main(void) {
    for (size_t i = 0; i < LOOPS; i++) {
        LOG_START;
        LOAD_AND_RESERVE_SCP(in);
        conv1d_int16(in, IN_LEN, filter, F_LEN, out);
        RELEASE_SCP(in);
        LOG_STOP;

        for (size_t j = 0; j < OUT_LEN; j++) {
            //printf("out[%d] = %d, ref[%d] = %d\n", j, out[j], j, ref[j]);
            if (out[j] != ref[j]) {
                write_mismatch(out[j], ref[j], j+1); // +1 to avoid writing 0
                fail();
            }
        }
    }
    pass();
}
